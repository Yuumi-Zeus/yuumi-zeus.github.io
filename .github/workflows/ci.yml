# å·¥ä½œæµåç§°
name: ci

# è§¦å‘æ¡ä»¶é…ç½®
on:
  push:
    # ä»…åœ¨æ¨é€åˆ° master æˆ– main åˆ†æ”¯æ—¶è§¦å‘
    branches:
      - master
      - main

# è®¾ç½®å·¥ä½œæµæƒé™ï¼ˆå…è®¸å†™å…¥å†…å®¹ï¼‰
permissions:
  contents: write

# å®šä¹‰å·¥ä½œåˆ—è¡¨
jobs:
  # éƒ¨ç½²ä»»åŠ¡
  deploy:
    # ä½¿ç”¨æœ€æ–°ç‰ˆ Ubuntu è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    # ğŸ”‘ æ–°å¢ç¯å¢ƒå˜é‡é…ç½®ï¼ˆä»ä»“åº“ Secrets è¯»å– Tokenï¼‰
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }} # å¯¹åº”ä»“åº“ Secrets ä¸­çš„ GH_TOKEN
    # ä»»åŠ¡æ­¥éª¤
    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»“åº“ä»£ç ï¼ˆä½¿ç”¨å®˜æ–¹ checkout åŠ¨ä½œï¼‰
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      # ç¬¬äºŒæ­¥ï¼šé…ç½® Git æäº¤èº«ä»½ï¼ˆç”¨äºåç»­ gh-deployï¼‰
      - name: Configure Git Credentials
        run: |
          git config user.name github-actions[bot]  # è®¾ç½®æœºå™¨äººçš„ç”¨æˆ·å
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com  # è®¾ç½®æœºå™¨äººçš„è®¤è¯é‚®ç®±

      # ç¬¬ä¸‰æ­¥ï¼šè®¾ç½® Python ç¯å¢ƒï¼ˆè‡ªåŠ¨å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ Pythonï¼‰
      - uses: actions/setup-python@v5
        with:
          python-version: 3.x # ä½¿ç”¨æœ€æ–°çš„ 3.x ç‰ˆæœ¬

      # ç¬¬å››æ­¥ï¼šç”Ÿæˆæ¯å‘¨æ›´æ–°çš„ç¼“å­˜ IDï¼ˆä½¿ç”¨ ISO å‘¨æ•°ï¼‰
      - run: echo "cache_id=$(date --utc '+%V')" >> $GITHUB_ENV

      # ç¬¬äº”æ­¥ï¼šç¼“å­˜ä¾èµ–ï¼ˆåŠ é€Ÿåç»­æ„å»ºï¼‰
      - uses: actions/cache@v4
        with:
          key: mkdocs-material-${{ env.cache_id }} # æ¯å‘¨è‡ªåŠ¨æ›´æ–°çš„ç¼“å­˜é”®
          path: .cache # ç¼“å­˜ç›®å½•è·¯å¾„
          restore-keys: | # å¤‡ç”¨åŒ¹é…æ¨¡å¼
            mkdocs-material-

      # ğŸš€ æ–°å¢ç¯å¢ƒå˜é‡ä¼ é€’ç»™æ„å»ºæµç¨‹
      # é€šè¿‡ --strict ç¡®ä¿ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ä½¿ç”¨ Token
      - name: Build Docs
        run: |
          pip install mkdocs-material mkdocs-rss-plugin \
              mkdocs-git-revision-date-localized-plugin \
              mkdocs-git-authors-plugin
          pip install -r requirements.txt
          mkdocs gh-deploy --force --strict

      # âœ… å®‰å…¨é˜²æŠ¤ï¼šè‡ªåŠ¨æ¸…ç†æ—¥å¿—ä¸­çš„ Token ç—•è¿¹ï¼ˆé˜²æ­¢æ„å¤–æ³„éœ²ï¼‰
      - name: Sanitize Logs
        if: always()
        run: |
          sed -i "s/$GH_TOKEN/***/g" $GITHUB_STEP_SUMMARY
